<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        h1 {
            text-align: center;
            color: #4CAF50;
        }
        .status {
            text-align: center;
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
            font-weight: bold;
            font-size: 18px;
        }
        .status.connected {
            background: #4CAF50;
            color: white;
        }
        .status.disconnected {
            background: #f44336;
            color: white;
        }
        .status.connecting {
            background: #ff9800;
            color: white;
        }
        .events {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .event-box {
            background: #2a2a2a;
            border: 2px solid #444;
            border-radius: 8px;
            padding: 15px;
        }
        .event-box h3 {
            margin-top: 0;
            color: #4CAF50;
            border-bottom: 2px solid #444;
            padding-bottom: 10px;
        }
        .event-count {
            font-size: 36px;
            font-weight: bold;
            text-align: center;
            margin: 15px 0;
            color: #4CAF50;
        }
        .event-time {
            text-align: center;
            color: #888;
            font-size: 12px;
        }
        .log {
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .log-entry {
            padding: 5px;
            border-bottom: 1px solid #222;
            margin-bottom: 5px;
        }
        .log-entry.success {
            color: #4CAF50;
        }
        .log-entry.error {
            color: #f44336;
        }
        .log-entry.info {
            color: #2196F3;
        }
        .log-entry.warning {
            color: #ff9800;
        }
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
            margin: 0 10px;
            transition: background 0.3s;
        }
        button:hover {
            background: #45a049;
        }
        button.danger {
            background: #f44336;
        }
        button.danger:hover {
            background: #da190b;
        }
    </style>
</head>
<body>
    <h1>üîå WebSocket Real-Time Test</h1>
    
    <div id="connectionStatus" class="status connecting">‚è≥ ƒêang k·∫øt n·ªëi...</div>
    
    <div class="controls">
        <button onclick="reconnect()">üîÑ Reconnect</button>
        <button onclick="clearLogs()" class="danger">üóëÔ∏è Clear Logs</button>
    </div>

    <div class="events">
        <div class="event-box">
            <h3>üìä Anomaly Detected</h3>
            <div id="anomalyCount" class="event-count">0</div>
            <div id="anomalyTime" class="event-time">Ch∆∞a c√≥ d·ªØ li·ªáu</div>
        </div>
        
        <div class="event-box">
            <h3>üö¶ Traffic Update</h3>
            <div id="trafficCount" class="event-count">0</div>
            <div id="trafficTime" class="event-time">Ch∆∞a c√≥ d·ªØ li·ªáu</div>
        </div>
        
        <div class="event-box">
            <h3>üö® Alert Created</h3>
            <div id="alertCount" class="event-count">0</div>
            <div id="alertTime" class="event-time">Ch∆∞a c√≥ d·ªØ li·ªáu</div>
        </div>
        
        <div class="event-box">
            <h3>ü§ñ Model Updated</h3>
            <div id="modelCount" class="event-count">0</div>
            <div id="modelTime" class="event-time">Ch∆∞a c√≥ d·ªØ li·ªáu</div>
        </div>
    </div>

    <div class="log" id="logContainer"></div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        let socket = null;
        let counts = {
            anomaly: 0,
            traffic: 0,
            alert: 0,
            model: 0
        };

        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logContainer.insertBefore(logEntry, logContainer.firstChild);
            
            // Keep only last 100 entries
            while (logContainer.children.length > 100) {
                logContainer.removeChild(logContainer.lastChild);
            }
        }

        function updateStatus(status, message) {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.className = `status ${status}`;
            statusEl.textContent = message;
        }

        function updateEventCount(type, data) {
            counts[type]++;
            document.getElementById(`${type}Count`).textContent = counts[type];
            document.getElementById(`${type}Time`).textContent = new Date().toLocaleTimeString();
        }

        function connectWebSocket() {
            const wsUrl = 'http://127.0.0.1:5000';
            
            addLog(`ƒêang k·∫øt n·ªëi t·ªõi ${wsUrl}...`, 'info');
            updateStatus('connecting', '‚è≥ ƒêang k·∫øt n·ªëi...');

            socket = io(wsUrl, {
                transports: ['websocket', 'polling'],
                reconnection: true,
                reconnectionAttempts: 5,
                reconnectionDelay: 1000
            });

            // Connection events
            socket.on('connect', () => {
                addLog('‚úÖ WebSocket connected successfully!', 'success');
                updateStatus('connected', '‚úÖ ƒê√£ k·∫øt n·ªëi - Real-time active');
            });

            socket.on('connected', (data) => {
                addLog(`‚úÖ Server confirmed: ${data.message}`, 'success');
                if (data.status) {
                    addLog(`üì° Status: ${data.status}`, 'info');
                }
            });

            socket.on('disconnect', (reason) => {
                addLog(`‚ùå Disconnected: ${reason}`, 'error');
                updateStatus('disconnected', '‚ùå M·∫•t k·∫øt n·ªëi');
            });

            socket.on('connect_error', (error) => {
                addLog(`‚ùå Connection error: ${error.message}`, 'error');
                updateStatus('disconnected', '‚ùå L·ªói k·∫øt n·ªëi');
            });

            // Data events
            socket.on('anomaly_detected', (data) => {
                addLog(`üìä ANOMALY DETECTED: ${data.type || 'Unknown'} from ${data.source_ip || 'N/A'} - Severity: ${data.severity || 'N/A'}`, 'warning');
                updateEventCount('anomaly', data);
            });

            socket.on('traffic_update', (data) => {
                addLog(`üö¶ TRAFFIC UPDATE: ${data.active_connections || 0} connections, ${data.bytes_sent || 0} bytes sent`, 'info');
                updateEventCount('traffic', data);
            });

            socket.on('alert_created', (data) => {
                addLog(`üö® ALERT CREATED: ${data.title || data.type || 'Alert'} - ${data.severity || 'Unknown'} severity`, 'error');
                updateEventCount('alert', data);
            });

            socket.on('model_updated', (data) => {
                addLog(`ü§ñ MODEL UPDATED: ${data.model || 'Unknown'} - Accuracy: ${data.accuracy || 'N/A'}`, 'success');
                updateEventCount('model', data);
            });
        }

        function reconnect() {
            addLog('üîÑ Manual reconnect requested...', 'info');
            if (socket) {
                socket.disconnect();
            }
            setTimeout(() => {
                connectWebSocket();
            }, 1000);
        }

        function clearLogs() {
            document.getElementById('logContainer').innerHTML = '';
            addLog('üóëÔ∏è Logs cleared', 'info');
        }

        // Initialize on load
        window.addEventListener('load', () => {
            connectWebSocket();
        });
    </script>
</body>
</html>
